<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ institute_name }} - Educational Assistant</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .rtl-text {
            direction: rtl;
            text-align: right;
        }
        .chat-container {
            height: calc(100vh - 280px);
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        .suggested-query:hover {
            background-color: #e0e7ff;
            cursor: pointer;
        }
        .loader {
            border-top-color: #4f46e5;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <!-- Navigation -->
    <nav class="bg-indigo-600 text-white p-4 shadow-md">
        <div class="container mx-auto flex justify-between items-center">
            <a href="/" class="text-xl font-bold">{{ institute_name }}</a>
            <div class="flex items-center space-x-2" id="nav-controls">
                <button id="login-btn" class="px-4 py-2 bg-white text-indigo-600 rounded-md hover:bg-indigo-100 transition">Login</button>
                <button id="register-btn" class="px-4 py-2 border border-white text-white rounded-md hover:bg-indigo-700 transition">Register</button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-4">
        <!-- Auth Forms Container -->
        <div id="auth-container" class="hidden">
            <!-- Login Form -->
            <div id="login-form" class="bg-white p-6 rounded-lg shadow-md max-w-md mx-auto my-8">
                <h2 class="text-2xl font-bold mb-6 text-center text-indigo-600">Login</h2>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2" for="login-email">Email</label>
                    <input type="email" id="login-email" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 mb-2" for="login-password">Password</label>
                    <input type="password" id="login-password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="flex justify-between items-center">
                    <button id="login-submit" class="px-6 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">Login</button>
                    <button class="text-indigo-600 hover:underline cancel-auth">Cancel</button>
                </div>
                <div id="login-error" class="mt-4 text-red-500 hidden"></div>
            </div>

            <!-- Register Form -->
            <div id="register-form" class="bg-white p-6 rounded-lg shadow-md max-w-md mx-auto my-8 hidden">
                <h2 class="text-2xl font-bold mb-6 text-center text-indigo-600">Register</h2>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2" for="register-name">Full Name</label>
                    <input type="text" id="register-name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2" for="register-email">Email</label>
                    <input type="email" id="register-email" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2" for="register-password">Password</label>
                    <input type="password" id="register-password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2" for="register-role">Role</label>
                    <select id="register-role" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="student">Student</option>
                        <option value="parent">Parent</option>
                        <option value="teacher">Teacher</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="mb-4" id="student-id-container">
                    <label class="block text-gray-700 mb-2" for="register-student-id">Student ID</label>
                    <input type="text" id="register-student-id" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 mb-2" for="register-lang">Language Preference</label>
                    <select id="register-lang" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="en">English</option>
                        <option value="ar">Arabic</option>
                    </select>
                </div>
                <div class="flex justify-between items-center">
                    <button id="register-submit" class="px-6 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">Register</button>
                    <button class="text-indigo-600 hover:underline cancel-auth">Cancel</button>
                </div>
                <div id="register-error" class="mt-4 text-red-500 hidden"></div>
            </div>
        </div>

        <!-- Main App Container -->
        <div id="app-container" class="hidden mt-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Left Sidebar -->
                <div class="md:col-span-1">
                    <div class="bg-white p-4 rounded-lg shadow-md mb-6">
                        <div class="flex items-center mb-4">
                            <span class="w-10 h-10 rounded-full bg-indigo-600 flex items-center justify-center text-white text-lg font-bold" id="user-avatar"></span>
                            <div class="ml-3">
                                <h2 class="font-bold" id="user-name"></h2>
                                <p class="text-sm text-gray-600" id="user-role"></p>
                            </div>
                        </div>
                        <button id="logout-btn" class="w-full px-3 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition">Logout</button>
                    </div>

                    <!-- Navigation Menu -->
                    <div class="bg-white p-4 rounded-lg shadow-md mb-6">
                        <h3 class="font-bold mb-4 text-indigo-700">Menu</h3>
                        <ul class="space-y-2">
                            <li>
                                <button id="menu-chat" class="w-full px-3 py-2 text-left hover:bg-indigo-100 rounded-md transition flex items-center">
                                    <i class="fas fa-comments mr-2"></i> Chat Assistant
                                </button>
                            </li>
                            <li id="file-management-container" class="hidden">
                                <button id="menu-files" class="w-full px-3 py-2 text-left hover:bg-indigo-100 rounded-md transition flex items-center">
                                    <i class="fas fa-file-alt mr-2"></i> Document Management
                                </button>
                            </li>
                            <li id="scores-container">
                                <button id="menu-scores" class="w-full px-3 py-2 text-left hover:bg-indigo-100 rounded-md transition flex items-center">
                                    <i class="fas fa-chart-bar mr-2"></i> Academic Scores
                                </button>
                            </li>
                            <li id="broadcast-container" class="hidden">
                                <button id="menu-broadcast" class="w-full px-3 py-2 text-left hover:bg-indigo-100 rounded-md transition flex items-center">
                                    <i class="fas fa-bullhorn mr-2"></i> Announcements
                                </button>
                            </li>
                        </ul>
                    </div>

                    <!-- Broadcasts -->
                    <div class="bg-white p-4 rounded-lg shadow-md">
                        <h3 class="font-bold mb-4 text-indigo-700">Recent Announcements</h3>
                        <div id="broadcasts-list" class="space-y-3">
                            <p class="text-gray-500 text-sm">Loading announcements...</p>
                        </div>
                    </div>
                </div>

                <!-- Main Content Area -->
                <div class="md:col-span-2">
                    <!-- Chat Interface -->
                    <div id="chat-section" class="bg-white p-4 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-indigo-700">Educational Assistant</h2>
                            <button id="clear-chat" class="text-sm text-gray-500 hover:text-indigo-700">
                                <i class="fas fa-trash-alt mr-1"></i> Clear Chat
                            </button>
                        </div>
                        <div id="chat-messages" class="chat-container mb-4">
                            <div class="bg-gray-100 p-4 rounded-lg mb-4">
                                <p>Welcome to the {{ institute_name }} Educational Assistant! How can I help you today?</p>
                            </div>
                        </div>
                        <div id="suggested-queries" class="mb-4 flex flex-wrap gap-2"></div>
                        <div class="flex items-center">
                            <input type="text" id="chat-input" class="flex-1 px-4 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Type your question...">
                            <button id="send-message" class="px-4 py-2 bg-indigo-600 text-white rounded-r-md hover:bg-indigo-700 transition">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>

                    <!-- File Management -->
                    <div id="files-section" class="bg-white p-4 rounded-lg shadow-md mt-6 hidden">
                        <h2 class="text-xl font-bold mb-4 text-indigo-700">Document Management</h2>
                        <div id="admin-file-controls" class="mb-6 p-4 bg-gray-100 rounded-lg hidden">
                            <h3 class="font-bold mb-2">Upload New Document</h3>
                            <form id="upload-form" class="flex flex-col space-y-3">
                                <input type="file" id="file-input" class="border border-gray-300 rounded-md p-2">
                                <div>
                                    <label class="block text-gray-700 mb-1">Document Visibility</label>
                                    <select id="file-visibility" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                        <option value="public">Public</option>
                                        <option value="private">Private (Admin/Teachers Only)</option>
                                    </select>
                                </div>
                                <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition">
                                    Upload Document
                                </button>
                            </form>
                        </div>
                        <div id="file-list-container">
                            <h3 class="font-bold mb-2">Available Documents</h3>
                            <div id="file-list" class="space-y-2">
                                <p class="text-gray-500">Loading documents...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Academic Scores -->
                    <div id="scores-section" class="bg-white p-4 rounded-lg shadow-md mt-6 hidden">
                        <h2 class="text-xl font-bold mb-4 text-indigo-700">Academic Scores</h2>
                        <div id="scores-data" class="space-y-4">
                            <p class="text-gray-500">Loading academic scores...</p>
                        </div>
                    </div>

                    <!-- Broadcast Management -->
                    <div id="broadcast-section" class="bg-white p-4 rounded-lg shadow-md mt-6 hidden">
                        <h2 class="text-xl font-bold mb-4 text-indigo-700">Send Announcement</h2>
                        <form id="broadcast-form" class="space-y-3">
                            <div>
                                <label class="block text-gray-700 mb-1">Target Audience</label>
                                <select id="broadcast-target" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    <option value="all">Everyone</option>
                                    <option value="student">Students Only</option>
                                    <option value="parent">Parents Only</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-1">Message</label>
                                <textarea id="broadcast-message" class="w-full px-3 py-2 border border-gray-300 rounded-md h-32" placeholder="Write your announcement here..."></textarea>
                            </div>
                            <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">
                                Send Announcement
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Welcome Screen -->
        <div id="welcome-container" class="mt-16">
            <div class="text-center max-w-3xl mx-auto">
                <h1 class="text-4xl font-bold text-indigo-700 mb-6">Welcome to {{ institute_name }}</h1>
                <p class="text-xl text-gray-600 mb-8">Your AI-powered educational assistant to help students, parents, and teachers collaborate effectively.</p>
                <div class="flex flex-col md:flex-row justify-center gap-4">
                    <button id="welcome-login" class="px-8 py-3 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition text-lg">
                        Login to Continue
                    </button>
                    <button id="welcome-register" class="px-8 py-3 border border-indigo-600 text-indigo-600 rounded-md hover:bg-indigo-50 transition text-lg">
                        Register Now
                    </button>
                </div>
                <div class="mt-12 grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="w-16 h-16 bg-indigo-100 text-indigo-600 flex items-center justify-center rounded-full mx-auto mb-4">
                            <i class="fas fa-user-graduate text-2xl"></i>
                        </div>
                        <h3 class="font-bold text-lg mb-2">For Students</h3>
                        <p class="text-gray-600">Access your academic performance, ask questions about your courses, and get personalized assistance.</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="w-16 h-16 bg-indigo-100 text-indigo-600 flex items-center justify-center rounded-full mx-auto mb-4">
                            <i class="fas fa-users text-2xl"></i>
                        </div>
                        <h3 class="font-bold text-lg mb-2">For Parents</h3>
                        <p class="text-gray-600">Stay updated with your child's progress, receive announcements, and communicate with teachers.</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="w-16 h-16 bg-indigo-100 text-indigo-600 flex items-center justify-center rounded-full mx-auto mb-4">
                            <i class="fas fa-chalkboard-teacher text-2xl"></i>
                        </div>
                        <h3 class="font-bold text-lg mb-2">For Teachers</h3>
                        <p class="text-gray-600">Manage student information, upload educational resources, and broadcast announcements.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-indigo-800 text-white py-6 mt-12">
        <div class="container mx-auto text-center">
            <p>&copy; 2025 {{ institute_name }}. All rights reserved.</p>
            <p class="mt-2 text-indigo-200">Powered by Advanced AI Technology</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Global variables
            let currentUser = null;
            let token = localStorage.getItem('token');
            let currentSection = 'chat';
            
            // DOM Elements
            const welcomeContainer = document.getElementById('welcome-container');
            const authContainer = document.getElementById('auth-container');
            const appContainer = document.getElementById('app-container');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            
            // Check if user is already logged in
            if (token) {
                try {
                    currentUser = JSON.parse(localStorage.getItem('user'));
                    showAppInterface();
                } catch (e) {
                    // Invalid user data, clear storage
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                }
            } else {
                showWelcomeScreen();
            }

            // Event Listeners for Authentication
            document.getElementById('login-btn').addEventListener('click', () => showAuthForm('login'));
            document.getElementById('register-btn').addEventListener('click', () => showAuthForm('register'));
            document.getElementById('welcome-login').addEventListener('click', () => showAuthForm('login'));
            document.getElementById('welcome-register').addEventListener('click', () => showAuthForm('register'));
            
            document.querySelectorAll('.cancel-auth').forEach(btn => {
                btn.addEventListener('click', () => {
                    authContainer.classList.add('hidden');
                    welcomeContainer.classList.remove('hidden');
                });
            });
            
            // Handle login submission
            document.getElementById('login-submit').addEventListener('click', handleLogin);
            
            // Handle register submission
            document.getElementById('register-submit').addEventListener('click', handleRegister);
            
            // Handle logout
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            
            // Handle student ID visibility
            document.getElementById('register-role').addEventListener('change', function() {
                const studentIdContainer = document.getElementById('student-id-container');
                if (this.value === 'student' || this.value === 'parent') {
                    studentIdContainer.classList.remove('hidden');
                } else {
                    studentIdContainer.classList.add('hidden');
                }
            });
            
            // Menu navigation
            document.getElementById('menu-chat').addEventListener('click', () => switchSection('chat'));
            document.getElementById('menu-files').addEventListener('click', () => switchSection('files'));
            document.getElementById('menu-scores').addEventListener('click', () => switchSection('scores'));
            document.getElementById('menu-broadcast').addEventListener('click', () => switchSection('broadcast'));
            
            // Chat functionality
            const chatInput = document.getElementById('chat-input');
            const sendButton = document.getElementById('send-message');
            
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            sendButton.addEventListener('click', sendMessage);
            
            // Clear chat
            document.getElementById('clear-chat').addEventListener('click', clearChat);
            
            // File upload form
            document.getElementById('upload-form')?.addEventListener('submit', function(e) {
                e.preventDefault();
                uploadFile();
            });
            
            // Broadcast form
            document.getElementById('broadcast-form')?.addEventListener('submit', function(e) {
                e.preventDefault();
                sendBroadcast();
            });
            
            // Functions
            function showWelcomeScreen() {
                welcomeContainer.classList.remove('hidden');
                authContainer.classList.add('hidden');
                appContainer.classList.add('hidden');
            }
            
            function showAuthForm(type) {
                welcomeContainer.classList.add('hidden');
                authContainer.classList.remove('hidden');
                
                if (type === 'login') {
                    loginForm.classList.remove('hidden');
                    registerForm.classList.add('hidden');
                } else {
                    loginForm.classList.add('hidden');
                    registerForm.classList.remove('hidden');
                }
            }
            
            function showAppInterface() {
                welcomeContainer.classList.add('hidden');
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                
                updateUserInfo();
                setupUserAccess();
                switchSection('chat');
                
                // Load initial data
                loadFileList();
                loadBroadcasts();
                loadScores();
            }
            
            function updateUserInfo() {
                if (!currentUser) return;
                
                document.getElementById('user-name').textContent = currentUser.name;
                document.getElementById('user-role').textContent = capitalizeFirstLetter(currentUser.role);
                document.getElementById('user-avatar').textContent = currentUser.name.charAt(0).toUpperCase();
            }
            
            function setupUserAccess() {
                const isAdmin = ['admin', 'teacher'].includes(currentUser.role);
                const fileManagementContainer = document.getElementById('file-management-container');
                const broadcastContainer = document.getElementById('broadcast-container');
                const adminFileControls = document.getElementById('admin-file-controls');
                
                // Show/hide file management menu
                fileManagementContainer.classList.remove('hidden');
                
                // Show/hide broadcast menu for admins/teachers
                if (isAdmin) {
                    broadcastContainer.classList.remove('hidden');
                } else {
                    broadcastContainer.classList.add('hidden');
                }
                
                // Show/hide file upload controls
                if (isAdmin && adminFileControls) {
                    adminFileControls.classList.remove('hidden');
                } else if (adminFileControls) {
                    adminFileControls.classList.add('hidden');
                }
            }
            
            function switchSection(section) {
                currentSection = section;
                
                // Hide all sections
                document.getElementById('chat-section').classList.add('hidden');
                document.getElementById('files-section').classList.add('hidden');
                document.getElementById('scores-section').classList.add('hidden');
                document.getElementById('broadcast-section').classList.add('hidden');
                
                // Show selected section
                document.getElementById(`${section}-section`).classList.remove('hidden');
            }
            
            async function handleLogin() {
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                const errorDiv = document.getElementById('login-error');
                
                if (!email || !password) {
                    errorDiv.textContent = 'Please fill in all fields';
                    errorDiv.classList.remove('hidden');
                    return;
                }
                
                try {
                    const response = await fetch('/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ email, password })
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.message || 'Login failed');
                    }
                    
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify({
                        id: data.user_id,
                        name: data.name,
                        email: data.email,
                        role: data.role,
                        language: data.language_preference
                    }));
                    
                    currentUser = {
                        id: data.user_id,
                        name: data.name,
                        email: data.email,
                        role: data.role,
                        language: data.language_preference
                    };
                    
                    showAppInterface();
                    
                } catch (error) {
                    errorDiv.textContent = error.message;
                    errorDiv.classList.remove('hidden');
                }
            }
            
            async function handleRegister() {
                const name = document.getElementById('register-name').value;
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const role = document.getElementById('register-role').value;
                const studentId = document.getElementById('register-student-id').value;
                const language = document.getElementById('register-lang').value;
                const errorDiv = document.getElementById('register-error');
                
                if (!name || !email || !password) {
                    errorDiv.textContent = 'Please fill in all required fields';
                    errorDiv.classList.remove('hidden');
                    return;
                }
                
                if ((role === 'student' || role === 'parent') && !studentId) {
                    errorDiv.textContent = 'Student ID is required for students and parents';
                    errorDiv.classList.remove('hidden');
                    return;
                }
                
                try {
                    const response = await fetch('/register', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name,
                            email,
                            password,
                            role,
                            student_id: studentId,
                            language_preference: language
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.message || 'Registration failed');
                    }
                    
                    // Show login form with success message
                    showAuthForm('login');
                    document.getElementById('login-email').value = email;
                    alert('Registration successful! Please log in.');
                    
                } catch (error) {
                    errorDiv.textContent = error.message;
                    errorDiv.classList.remove('hidden');
                }
            }
            
            function handleLogout() {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                currentUser = null;
                showWelcomeScreen();
            }
            
            function addMessage(message, isUser = false) {
                const chatMessages = document.getElementById('chat-messages');
                const messageDiv = document.createElement('div');
                messageDiv.className = isUser ? 
                    'bg-indigo-100 p-4 rounded-lg mb-4 ml-12' : 
                    'bg-gray-100 p-4 rounded-lg mb-4 mr-12';
                
                // Handle RTL text for Arabic
                if (message.match(/[\u0600-\u06FF]/)) {
                    messageDiv.classList.add('rtl-text');
                }
                
                messageDiv.innerHTML = message.replace(/\n/g, '<br>');
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            function addLoadingIndicator() {
                const chatMessages = document.getElementById('chat-messages');
                const loadingDiv = document.createElement('div');
                loadingDiv.id = 'loading-indicator';
                loadingDiv.className = 'bg-gray-100 p-4 rounded-lg mb-4 mr-12 flex items-center';
                loadingDiv.innerHTML = `
                    <div class="loader w-5 h-5 border-2 border-gray-300 border-t-2 rounded-full mr-3"></div>
                    <span>Thinking...</span>
                `;
                chatMessages.appendChild(loadingDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            function removeLoadingIndicator() {
                const indicator = document.getElementById('loading-indicator');
                if (indicator) {
                    indicator.remove();
                }
            }
            
            async function sendMessage() {
                const chatInput = document.getElementById('chat-input');
                const query = chatInput.value.trim();
                
                if (!query) return;
                
                addMessage(query, true);
                chatInput.value = '';
                
                // Show loading indicator
                addLoadingIndicator();
                
                try {
                    const response = await fetch('/query', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-access-token': token
                        },
                        body: JSON.stringify({ query })});
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.message || 'Failed to get response');
                    }
                    
                    // Remove loading indicator
                    removeLoadingIndicator();
                    
                    // Display response
                    addMessage(data.response);
                    
                    // Display suggested queries
                    updateSuggestedQueries(data.suggested_queries);
                    
                } catch (error) {
                    removeLoadingIndicator();
                    addMessage(`Error: ${error.message}`);
                }
            }
            
            function updateSuggestedQueries(queries) {
                const container = document.getElementById('suggested-queries');
                container.innerHTML = '';
                
                if (!queries || queries.length === 0) return;
                
                queries.forEach(query => {
                    const chip = document.createElement('div');
                    chip.className = 'suggested-query px-3 py-1 bg-indigo-50 text-indigo-800 rounded-full text-sm border border-indigo-200';
                    
                    // Handle RTL text for Arabic
                    if (query.match(/[\u0600-\u06FF]/)) {
                        chip.classList.add('rtl-text');
                    }
                    
                    chip.textContent = query;
                    chip.addEventListener('click', () => {
                        document.getElementById('chat-input').value = query;
                        sendMessage();
                    });
                    
                    container.appendChild(chip);
                });
            }
            
            async function clearChat() {
                if (!confirm('Are you sure you want to clear the chat history?')) return;
                
                try {
                    await fetch('/clear_memory', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-access-token': token
                        }
                    });
                    
                    const chatMessages = document.getElementById('chat-messages');
                    chatMessages.innerHTML = `
                        <div class="bg-gray-100 p-4 rounded-lg mb-4">
                            <p>Chat history cleared. How can I help you today?</p>
                        </div>
                    `;
                    
                    document.getElementById('suggested-queries').innerHTML = '';
                    
                } catch (error) {
                    alert(`Error clearing chat: ${error.message}`);
                }
            }
            
            async function loadFileList() {
                try {
                    const response = await fetch('/list_files', {
                        method: 'GET',
                        headers: {
                            'x-access-token': token
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.message || 'Failed to load documents');
                    }
                    
                    const fileList = document.getElementById('file-list');
                    fileList.innerHTML = '';
                    
                    if (data.files.length === 0) {
                        fileList.innerHTML = '<p class="text-gray-500">No documents available.</p>';
                        return;
                    }
                    
                    const isAdmin = ['admin', 'teacher'].includes(currentUser.role);
                    
                    data.files.forEach(file => {
                        const fileItem = document.createElement('div');
                        fileItem.className = 'flex justify-between items-center bg-gray-50 p-3 rounded border border-gray-200';
                        
                        fileItem.innerHTML = `
                            <div>
                                <i class="fas fa-file-alt text-indigo-600 mr-2"></i>
                                <span>${file}</span>
                            </div>
                        `;
                        
                        // Add delete button for admins
                        if (isAdmin) {
                            const deleteBtn = document.createElement('button');
                            deleteBtn.className = 'text-red-500 hover:text-red-700';
                            deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
                            deleteBtn.addEventListener('click', () => deleteFile(file));
                            fileItem.querySelector('div').appendChild(deleteBtn);
                        }
                        
                        fileList.appendChild(fileItem);
                    });
                    
                } catch (error) {
                    document.getElementById('file-list').innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
                }
            }
            
            async function uploadFile() {
                const fileInput = document.getElementById('file-input');
                const visibility = document.getElementById('file-visibility').value;
                
                if (!fileInput.files[0]) {
                    alert('Please select a file to upload.');
                    return;
                }
                
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                formData.append('metadata', JSON.stringify({
                    public: visibility === 'public',
                    uploaded_by: currentUser.id
                }));
                
                try {
                    const response = await fetch('/upload', {
                        method: 'POST',
                        headers: {
                            'x-access-token': token
                        },
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.message || 'Upload failed');
                    }
                    
                    alert('File uploaded successfully!');
                    fileInput.value = '';
                    loadFileList();
                    
                } catch (error) {
                    alert(`Upload error: ${error.message}`);
                }
            }
            
            async function deleteFile(filename) {
                if (!confirm(`Are you sure you want to delete "${filename}"?`)) return;
                
                try {
                    const response = await fetch('/delete', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-access-token': token
                        },
                        body: JSON.stringify({ filename })
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.message || 'Deletion failed');
                    }
                    
                    alert('File deleted successfully!');
                    loadFileList();
                    
                } catch (error) {
                    alert(`Deletion error: ${error.message}`);
                }
            }
            
            async function loadScores() {
                try {
                    const isAdmin = ['admin', 'teacher'].includes(currentUser.role);
                    let url = '/get_scores';
                    
                    if (isAdmin) {
                        const studentId = prompt('Enter student ID to view scores:');
                        if (!studentId) return;
                        url += `?student_id=${studentId}`;
                    }
                    
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'x-access-token': token
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.message || 'Failed to load scores');
                    }
                    
                    const scoresContainer = document.getElementById('scores-data');
                    scoresContainer.innerHTML = '';
                    
                    if (!data.scores || data.scores.length === 0) {
                        scoresContainer.innerHTML = '<p class="text-gray-500">No academic scores available.</p>';
                        return;
                    }
                    
                    // Group scores by subject
                    const subjects = {};
                    data.scores.forEach(score => {
                        if (!subjects[score.subject]) {
                            subjects[score.subject] = [];
                        }
                        subjects[score.subject].push(score);
                    });
                    
                    // Create subject cards
                    for (const [subject, scores] of Object.entries(subjects)) {
                        const subjectCard = document.createElement('div');
                        subjectCard.className = 'bg-gray-50 p-4 rounded-lg border border-gray-200';
                        
                        let subjectHtml = `
                            <h3 class="font-bold text-lg text-indigo-700 mb-3">${subject}</h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full bg-white">
                                    <thead>
                                        <tr class="bg-gray-200 text-gray-700">
                                            <th class="py-2 px-4 text-left">Exam Type</th>
                                            <th class="py-2 px-4 text-left">Score</th>
                                            <th class="py-2 px-4 text-left">Percentage</th>
                                            <th class="py-2 px-4 text-left">Date</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;
                        
                        scores.forEach(score => {
                            const percentage = ((score.score / score.max_score) * 100).toFixed(1);
                            let color = 'text-green-600';
                            if (percentage < 70) color = 'text-yellow-600';
                            if (percentage < 60) color = 'text-red-600';
                            
                            subjectHtml += `
                                <tr class="border-b border-gray-200">
                                    <td class="py-2 px-4">${score.exam_type}</td>
                                    <td class="py-2 px-4">${score.score}/${score.max_score}</td>
                                    <td class="py-2 px-4 ${color} font-bold">${percentage}%</td>
                                    <td class="py-2 px-4">${score.date}</td>
                                </tr>
                            `;
                        });
                        
                        subjectHtml += `
                                    </tbody>
                                </table>
                            </div>
                        `;
                        
                        subjectCard.innerHTML = subjectHtml;
                        scoresContainer.appendChild(subjectCard);
                    }
                    
                } catch (error) {
                    document.getElementById('scores-data').innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
                }
            }
            
            async function loadBroadcasts() {
                try {
                    const response = await fetch('/get_broadcasts', {
                        method: 'GET',
                        headers: {
                            'x-access-token': token
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.message || 'Failed to load announcements');
                    }
                    
                    const broadcastsList = document.getElementById('broadcasts-list');
                    broadcastsList.innerHTML = '';
                    
                    if (!data.broadcasts || data.broadcasts.length === 0) {
                        broadcastsList.innerHTML = '<p class="text-gray-500 text-sm">No announcements available.</p>';
                        return;
                    }
                    
                    data.broadcasts.forEach(broadcast => {
                        const broadcastItem = document.createElement('div');
                        broadcastItem.className = 'bg-gray-50 p-3 rounded border border-gray-200 text-sm';
                        
                        // Check if text is Arabic
                        const isArabic = /[\u0600-\u06FF]/.test(broadcast.message);
                        if (isArabic) {
                            broadcastItem.classList.add('rtl-text');
                        }
                        
                        broadcastItem.innerHTML = `
                            <div class="font-bold text-indigo-700">${broadcast.sender}</div>
                            <div class="my-1">${broadcast.message}</div>
                            <div class="text-gray-500 text-xs">${broadcast.timestamp}</div>
                        `;
                        
                        broadcastsList.appendChild(broadcastItem);
                    });
                    
                } catch (error) {
                    document.getElementById('broadcasts-list').innerHTML = `<p class="text-red-500 text-sm">Error: ${error.message}</p>`;
                }
            }
            
            async function sendBroadcast() {
                const target = document.getElementById('broadcast-target').value;
                const message = document.getElementById('broadcast-message').value;
                
                if (!message) {
                    alert('Please enter a message to broadcast.');
                    return;
                }
                
                try {
                    const response = await fetch('/broadcast', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-access-token': token
                        },
                        body: JSON.stringify({ message, target_role: target })
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.message || 'Broadcast failed');
                    }
                    
                    alert('Announcement sent successfully!');
                    document.getElementById('broadcast-message').value = '';
                    loadBroadcasts();
                    
                } catch (error) {
                    alert(`Error sending announcement: ${error.message}`);
                }
            }
            
            // Utility functions
            function capitalizeFirstLetter(string) {
                return string.charAt(0).toUpperCase() + string.slice(1);
            }
        });
    </script>
</body>
</html>